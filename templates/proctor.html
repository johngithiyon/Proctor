<!DOCTYPE html>
<html>
<head>
    <title>Proctor Mode Exam</title>
    <style>
        body { font-family: sans-serif; text-align:center; margin-top:50px; }
        #video { border: 2px solid #ccc; border-radius: 8px; }
        #status { font-weight: bold; margin-top: 10px; }
        .violation { color: red; animation: blink 1s linear infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        #violation-count {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .violation-badge {
            display: inline-block;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <h2>Proctor Mode Exam</h2>
    <p>Student: <span id="student-name"></span></p>
    <p>Exam: <span id="exam-name"></span></p>
    <video id="video" width="400" height="300" autoplay></video>
    <p id="status">Exam started... Maintaining silence is required.</p>
    
    <div id="violation-count">
        Violations: <span id="count">0</span><span class="violation-badge" id="badge" style="display: none;">!</span>
    </div>

    <script>
        const video = document.getElementById('video');
        const status = document.getElementById('status');
        const violationCount = document.getElementById('count');
        const violationBadge = document.getElementById('badge');

        // Get username and exam from URL
        const params = new URLSearchParams(window.location.search);
        const username = params.get('user');
        const exam = params.get('exam');
        document.getElementById('student-name').innerText = username;
        document.getElementById('exam-name').innerText = exam;

        let audioContext;
        let analyser;
        let microphone;
        let javascriptNode;
        let isNoiseViolation = false;

        // Access webcam and microphone
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                video.srcObject = stream;

                // --- Audio Analysis Setup ---
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);

                analyser.smoothingTimeConstant = 0.8;
                analyser.fftSize = 1024;

                microphone.connect(analyser);
                analyser.connect(javascriptNode);
                javascriptNode.connect(audioContext.destination);

                javascriptNode.onaudioprocess = function() {
                    const array = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(array);
                    let values = 0;

                    const length = array.length;
                    for (let i = 0; i < length; i++) {
                        values += array[i];
                    }

                    const average = values / length;
                    
                    // --- Noise Threshold ---
                    // This threshold might need tuning based on environment.
                    // 30 is a good starting point for detecting talking.
                    if (average > 30) {
                        isNoiseViolation = true;
                    } else {
                        isNoiseViolation = false;
                    }
                };
            })
            .catch(err => {
                console.error("Error accessing media devices.", err);
                status.innerText = "Error: Could not access camera or microphone.";
            });

        // Capture image every 10 seconds for proctoring
        setInterval(() => {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const dataURL = canvas.toDataURL('image/png');

            fetch('/capture', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `image=${encodeURIComponent(dataURL)}&username=${encodeURIComponent(username)}&noise_violation=${isNoiseViolation}`
            })
            .then(res => res.text())
            .then(resp => {
                if(resp === 'FACE_MISMATCH'){
                    status.innerText = "Face Mismatch Exam Terminated!";
                    video.pause();
                    alert("Face mismatch detected. The exam will be terminated.");
                    window.location.href = "/";
                } else if(resp === 'MAX_VIOLATIONS'){ // Added handling for MAX_VIOLATIONS
                    status.innerText = "Maximum Violations Reached Exam Terminated!";
                    video.pause();
                    alert("The maximum violations reached. Exam terminated.");
                    window.location.href = "/";
                } else if(resp.startsWith('VIOLATION:')) {
                    // Extract violation count from response
                    const count = parseInt(resp.split(':')[1]);
                    violationCount.innerText = count;
                    violationBadge.style.display = 'inline-block';
                    status.innerText = `Violation ${count}: Excessive noise detected! Please remain silent.`;
                    
                    // Flash the violation badge
                    violationBadge.style.animation = 'none';
                    setTimeout(() => {
                        violationBadge.style.animation = 'blink 1s linear infinite';
                    }, 10);
                } else {
                    // If no violation is returned from backend, ensure status is neutral
                    if (!status.innerText.includes("Violation")) {
                       status.innerText = "Exam in progress...";
                    }
                }
            })
            .catch(err => console.error('Error during capture:', err));
        }, 10000);
    </script>

    <p>Answer your MCQs below:</p>
    <form id="mcq-form">
        <div>
            <p>1. Which of the following is a type of supervised learning?</p>
            <input type="radio" name="q1" value="a"> a) K-Means Clustering<br>
            <input type="radio" name="q1" value="b"> b) Linear Regression<br>
            <input type="radio" name="q1" value="c"> c) PCA<br>
            <input type="radio" name="q1" value="d"> d) Apriori Algorithm<br>
        </div>
        <div>
            <p>2. Which activation function is commonly used in deep learning?</p>
            <input type="radio" name="q2" value="a"> a) ReLU<br>
            <input type="radio" name="q2" value="b"> b) Linear<br>
            <input type="radio" name="q2" value="c"> c) Sigmoid<br>
            <input type="radio" name="q2" value="d"> d) Both a and c<br>
        </div>
        <div>
            <p>3. Which algorithm is used for classification problems?</p>
            <input type="radio" name="q3" value="a"> a) Decision Tree<br>
            <input type="radio" name="q3" value="b"> b) K-Means<br>
            <input type="radio" name="q3" value="c"> c) PCA<br>
            <input type="radio" name="q3" value="d"> d) Apriori<br>
        </div>
        <div>
            <p>4. What does "AI" stand for?</p>
            <input type="radio" name="q4" value="a"> a) Automated Interface<br>
            <input type="radio" name="q4" value="b"> b) Artificial Intelligence<br>
            <input type="radio" name="q4" value="c"> c) Algorithmic Integration<br>
            <input type="radio" name="q4" value="d"> d) Automatic Instruction<br>
        </div>
        <div>
            <p>5. Which of the following is a type of reinforcement learning?</p>
            <input type="radio" name="q5" value="a"> a) Q-Learning<br>
            <input type="radio" name="q5" value="b"> b) Linear Regression<br>
            <input type="radio" name="q5" value="c"> c) KNN<br>
            <input type="radio" name="q5" value="d"> d) PCA<br>
        </div>
        <br>
        <button type="button" onclick="submitMCQ()">Submit Answers</button>
    </form>

    <script>
        function submitMCQ() {
            const form = document.getElementById('mcq-form');
            const formData = new FormData(form);

            const answers = {
                q1: 'b', q2: 'd', q3: 'a', q4: 'b', q5: 'a'
            };

            let score = 0;
            for (let [q, a] of Object.entries(answers)) {
                if (formData.get(q) === a) score++;
            }

            fetch('/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `username=${encodeURIComponent(username)}&score=${score}`
            })
            .then(res => res.text())
            .then(() => window.location.href = `/score?user=${encodeURIComponent(username)}`)
            .catch(err => console.error(err));
        }
    </script>
</body>
</html>