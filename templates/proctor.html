<!DOCTYPE html>
<html>
<head>
    <title>Proctor Mode Exam</title>
    <style>
        body { 
            font-family: sans-serif; 
            text-align:center; 
            margin-top:50px; 
            overflow: hidden; /* Prevent scrolling when in fullscreen */
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .header-section {
            flex-shrink: 0;
            padding: 10px;
        }
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .video-section {
            flex: 0 0 400px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .questions-section {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            text-align: left;
            padding-bottom: 80px; /* Add padding to ensure submit button is always visible */
            position: relative; /* Added for overlay positioning */
        }
        #video { border: 2px solid #ccc; border-radius: 8px; }
        #status { font-weight: bold; margin-top: 10px; }
        .violation { color: red; animation: blink 1s linear infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        #violation-count {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 100;
        }
        .violation-badge {
            display: inline-block;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            margin-left: 10px;
        }
        .fullscreen-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .fullscreen-warning h2 {
            margin-bottom: 20px;
        }
        .fullscreen-warning button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .fullscreen-warning button:hover {
            background-color: #45a049;
        }
        .question {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .question p {
            margin-bottom: 10px;
            font-weight: bold;
            user-select: none; /* Prevent text selection for question text only */
            -webkit-user-select: none; /* For Safari */
            -moz-user-select: none; /* For Firefox */
            -ms-user-select: none; /* For IE/Edge */
        }
        .question-options {
            margin-left: 20px;
        }
        .question-options label {
            display: block;
            margin-bottom: 5px;
            cursor: pointer;
            user-select: none; /* Prevent text selection for options */
            -webkit-user-select: none; /* For Safari */
            -moz-user-select: none; /* For Firefox */
            -ms-user-select: none; /* For IE/Edge */
        }
        .submit-section {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px;
            text-align: center;
            background-color: #f8f9fa;
            border-top: 1px solid #ddd;
            z-index: 100;
        }
        .submit-button {
            padding: 12px 30px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .submit-button:hover {
            background-color: #45a049;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .submit-instruction {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        .debug-info {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
            display: none;
        }
        /* Added styles for screenshot prevention */
        .screenshot-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .screenshot-warning h2 {
            margin-bottom: 20px;
            color: #ff5252;
        }
        .screenshot-warning p {
            max-width: 600px;
            text-align: center;
            margin-bottom: 20px;
        }
        .screenshot-warning button {
            padding: 10px 20px;
            background-color: #ff5252;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .screenshot-warning button:hover {
            background-color: #e04141;
        }
        /* Watermark overlay */
        .watermark-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9998;
            opacity: 0.05;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="300"><text x="50%" y="50%" font-size="20" text-anchor="middle" dominant-baseline="middle" transform="rotate(-45 150 150)" fill="%23000">PROTECTED EXAM CONTENT</text></svg>');
            background-repeat: repeat;
            display: none;
        }
        /* Anti-screenshot overlay */
        .anti-screenshot {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.01);
            pointer-events: none;
            z-index: 9997;
            display: none;
        }
    </style>
</head>
<body>
    <div class="header-section">
        <h2>Proctor Mode Exam</h2>
        <p>Student: <span id="student-name"></span></p>
        <p>Exam: <span id="exam-name"></span></p>
    </div>

    <div class="main-content">
        <div class="video-section">
            <video id="video" width="400" height="300" autoplay></video>
            <p id="status">Exam started... Please maintain silence and look at the screen.</p>
            <button id="debug-toggle" style="margin-top: 10px; padding: 5px 10px; font-size: 12px;">Toggle Debug</button>
        </div>

        <div class="questions-section">
            <h3>Answer your MCQs below:</h3>
            <form id="mcq-form">
                <div class="question">
                    <p>1. Which of the following is a type of supervised learning?</p>
                    <div class="question-options">
                        <label><input type="radio" name="q1" value="a"> a) K-Means Clustering</label>
                        <label><input type="radio" name="q1" value="b"> b) Linear Regression</label>
                        <label><input type="radio" name="q1" value="c"> c) PCA</label>
                        <label><input type="radio" name="q1" value="d"> d) Apriori Algorithm</label>
                    </div>
                </div>
                <div class="question">
                    <p>2. Which activation function is commonly used in deep learning?</p>
                    <div class="question-options">
                        <label><input type="radio" name="q2" value="a"> a) ReLU</label>
                        <label><input type="radio" name="q2" value="b"> b) Linear</label>
                        <label><input type="radio" name="q2" value="c"> c) Sigmoid</label>
                        <label><input type="radio" name="q2" value="d"> d) Both a and c</label>
                    </div>
                </div>
                <div class="question">
                    <p>3. Which algorithm is used for classification problems?</p>
                    <div class="question-options">
                        <label><input type="radio" name="q3" value="a"> a) Decision Tree</label>
                        <label><input type="radio" name="q3" value="b"> b) K-Means</label>
                        <label><input type="radio" name="q3" value="c"> c) PCA</label>
                        <label><input type="radio" name="q3" value="d"> d) Apriori</label>
                    </div>
                </div>
                <div class="question">
                    <p>4. What does "AI" stand for?</p>
                    <div class="question-options">
                        <label><input type="radio" name="q4" value="a"> a) Automated Interface</label>
                        <label><input type="radio" name="q4" value="b"> b) Artificial Intelligence</label>
                        <label><input type="radio" name="q4" value="c"> c) Algorithmic Integration</label>
                        <label><input type="radio" name="q4" value="d"> d) Automatic Instruction</label>
                    </div>
                </div>
                <div class="question">
                    <p>5. Which of the following is a type of reinforcement learning?</p>
                    <div class="question-options">
                        <label><input type="radio" name="q5" value="a"> a) Q-Learning</label>
                        <label><input type="radio" name="q5" value="b"> b) Linear Regression</label>
                        <label><input type="radio" name="q5" value="c"> c) KNN</label>
                        <label><input type="radio" name="q5" value="d"> d) PCA</label>
                    </div>
                </div>
            </form>
            <div class="submit-instruction">
                <p>Submit button is located at the bottom of the page</p>
            </div>
        </div>
    </div>

    <div class="submit-section">
        <button type="button" class="submit-button" onclick="submitMCQ()">Submit Answers</button>
    </div>
    
    <div id="violation-count">
        Violations: <span id="count">0</span><span class="violation-badge" id="badge" style="display: none;">!</span>
    </div>

    <div id="fullscreen-warning" class="fullscreen-warning" style="display: none;">
        <h2>Fullscreen Mode Required</h2>
        <p>This exam must be taken in fullscreen mode. Please click the button below to enter fullscreen.</p>
        <button onclick="enterFullscreen()">Enter Fullscreen</button>
    </div>

    <div id="screenshot-warning" class="screenshot-warning">
        <h2>Screenshot/Screen Recording Detected</h2>
        <p>Screenshots and screen recordings are strictly prohibited during this exam. This incident has been recorded and will be reported to your instructor.</p>
        <button onclick="hideScreenshotWarning()">I Understand</button>
    </div>

    <div class="watermark-overlay" id="watermark-overlay"></div>
    <div class="anti-screenshot" id="anti-screenshot"></div>

    <div id="debug-info" class="debug-info">
        <h4>Debug Information</h4>
        <div id="debug-content"></div>
    </div>

    <script>
        const video = document.getElementById('video');
        const status = document.getElementById('status');
        const violationCountSpan = document.getElementById('count');
        const violationBadge = document.getElementById('badge');
        const fullscreenWarning = document.getElementById('fullscreen-warning');
        const screenshotWarning = document.getElementById('screenshot-warning');
        const watermarkOverlay = document.getElementById('watermark-overlay');
        const antiScreenshot = document.getElementById('anti-screenshot');
        const debugToggle = document.getElementById('debug-toggle');
        const debugInfo = document.getElementById('debug-info');
        const debugContent = document.getElementById('debug-content');

        const params = new URLSearchParams(window.location.search);
        const username = params.get('user');
        const exam = params.get('exam');
        // IMPORTANT: Assume reference_face is passed as a URL parameter from the login page
        const referenceFace = params.get('reference_face'); 

        document.getElementById('student-name').innerText = username;
        document.getElementById('exam-name').innerText = exam;

        let audioContext;
        let analyser;
        let microphone;
        let javascriptNode;
        let isNoiseViolation = false;
        let isFullscreen = false;
        let examSubmitted = false;
        let debugMode = false;
        let lastViolationCount = 0;
        let screenshotWarningShown = false;
        let lastScreenshotTime = 0;

        // Toggle debug mode
        debugToggle.addEventListener('click', function() {
            debugMode = !debugMode;
            debugInfo.style.display = debugMode ? 'block' : 'none';
        });

        // Function to update debug information
        function updateDebugInfo(message) {
            if (debugMode) {
                const timestamp = new Date().toLocaleTimeString();
                debugContent.innerHTML = `<div>[${timestamp}] ${message}</div>` + debugContent.innerHTML;
                // Keep only the last 10 messages
                const messages = debugContent.children;
                if (messages.length > 10) {
                    debugContent.removeChild(messages[messages.length - 1]);
                }
            }
        }

        // Function to enter fullscreen
        function enterFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) { /* Safari */
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) { /* IE11 */
                elem.msRequestFullscreen();
            }
            fullscreenWarning.style.display = 'none';
            isFullscreen = true;
            updateDebugInfo("Entered fullscreen mode");
        }

        // Function to exit fullscreen
        function exitFullscreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) { /* Safari */
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { /* IE11 */
                document.msExitFullscreen();
            }
            updateDebugInfo("Exited fullscreen mode");
        }

        // Function to hide screenshot warning
        function hideScreenshotWarning() {
            screenshotWarning.style.display = 'none';
            screenshotWarningShown = false;
        }

        // Function to show screenshot warning
        function showScreenshotWarning() {
            if (!screenshotWarningShown) {
                screenshotWarning.style.display = 'flex';
                screenshotWarningShown = true;
                updateDebugInfo("Screenshot warning shown");
            }
        }

        // Function to trigger anti-screenshot measures
        function triggerAntiScreenshot() {
            const now = Date.now();
            if (now - lastScreenshotTime > 1000) { // Prevent multiple triggers in 1 second
                lastScreenshotTime = now;
                
                // Show watermark overlay
                watermarkOverlay.style.display = 'block';
                antiScreenshot.style.display = 'block';
                
                // Flash the screen
                document.body.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
                setTimeout(() => {
                    document.body.style.backgroundColor = '';
                }, 200);
                
                // Hide overlays after a delay
                setTimeout(() => {
                    watermarkOverlay.style.display = 'none';
                    antiScreenshot.style.display = 'none';
                }, 2000);
                
                reportScreenshotViolation();
                showScreenshotWarning();
            }
        }

        // Listen for fullscreen changes
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);

        function handleFullscreenChange() {
            const isCurrentlyFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || 
                document.mozFullScreenElement || document.msFullscreenElement);
            
            if (!isCurrentlyFullscreen && isFullscreen && !examSubmitted) {
                // User exited fullscreen mode
                reportFullscreenViolation();
                
                // Show warning
                fullscreenWarning.style.display = 'flex';
                isFullscreen = false;
                updateDebugInfo("Fullscreen violation detected");
            } else if (isCurrentlyFullscreen) {
                fullscreenWarning.style.display = 'none';
                isFullscreen = true;
                updateDebugInfo("Fullscreen mode active");
            }
        }

        // Generic function to handle violation responses
        function handleViolationResponse(resp, defaultMessage) {
            if(resp.startsWith('VIOLATION:')){
                const respParts = resp.split(':');
                const count = parseInt(respParts[respParts.length - 1]);
                
                // Only update if count is higher than last count to prevent duplicates
                if (count > lastViolationCount) {
                    lastViolationCount = count;
                    violationCountSpan.innerText = count;
                    violationBadge.style.display = 'inline-block';
                    
                    status.innerText = defaultMessage.replace('{count}', count);
                    status.classList.add('violation');
                    
                    violationBadge.style.animation = 'none';
                    setTimeout(() => {
                        violationBadge.style.animation = 'blink 1s linear infinite';
                    }, 10);
                }
                
                if (resp === 'MAX_VIOLATIONS') {
                    status.innerText = "Maximum Violations Reached. Exam Terminated!";
                    video.pause();
                    alert("The maximum violations reached. Exam terminated.");
                    window.location.href = "/";
                }
            }
        }

        // Function to report fullscreen violation
        function reportFullscreenViolation() {
            fetch('/fullscreen-violation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `username=${encodeURIComponent(username)}`
            })
            .then(res => res.text())
            .then(resp => {
                handleViolationResponse(resp, `Violation {count}: You exited fullscreen mode. Please return to fullscreen.`);
                updateDebugInfo(`Fullscreen violation response: ${resp}`);
            })
            .catch(err => {
                console.error('Error reporting fullscreen violation:', err);
                updateDebugInfo(`Error reporting fullscreen violation: ${err.message}`);
            });
        }

        // Function to report tab change violation
        function reportTabChangeViolation() {
            if (examSubmitted) return;
            
            fetch('/tab-change-violation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `username=${encodeURIComponent(username)}`
            })
            .then(res => res.text())
            .then(resp => {
                handleViolationResponse(resp, `Violation {count}: Tab change detected! Please focus on the exam.`);
                updateDebugInfo(`Tab change violation response: ${resp}`);
            })
            .catch(err => {
                console.error('Error reporting tab change violation:', err);
                updateDebugInfo(`Error reporting tab change violation: ${err.message}`);
            });
        }

        // Function to report window change violation
        function reportWindowChangeViolation() {
            if (examSubmitted) return;
            
            fetch('/window-change-violation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `username=${encodeURIComponent(username)}`
            })
            .then(res => res.text())
            .then(resp => {
                handleViolationResponse(resp, `Violation {count}: Window change detected! Please focus on the exam.`);
                updateDebugInfo(`Window change violation response: ${resp}`);
            })
            .catch(err => {
                console.error('Error reporting window change violation:', err);
                updateDebugInfo(`Error reporting window change violation: ${err.message}`);
            });
        }

        // Function to report copy attempt violation
        function reportCopyAttemptViolation() {
            if (examSubmitted) return;
            
            fetch('/copy-attempt-violation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `username=${encodeURIComponent(username)}`
            })
            .then(res => res.text())
            .then(resp => {
                handleViolationResponse(resp, `Violation {count}: Copy attempt detected! Copying questions is not allowed.`);
                updateDebugInfo(`Copy attempt violation response: ${resp}`);
            })
            .catch(err => {
                console.error('Error reporting copy attempt violation:', err);
                updateDebugInfo(`Error reporting copy attempt violation: ${err.message}`);
            });
        }

        // Function to report screenshot violation
        function reportScreenshotViolation() {
            if (examSubmitted) return;
            
            fetch('/screenshot-violation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `username=${encodeURIComponent(username)}`
            })
            .then(res => res.text())
            .then(resp => {
                handleViolationResponse(resp, `Violation {count}: Screenshot or screen recording detected! This is strictly prohibited.`);
                updateDebugInfo(`Screenshot violation response: ${resp}`);
            })
            .catch(err => {
                console.error('Error reporting screenshot violation:', err);
                updateDebugInfo(`Error reporting screenshot violation: ${err.message}`);
            });
        }

        // Detect tab changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                reportTabChangeViolation();
            }
        });

        // Detect window focus changes
        window.addEventListener('blur', function() {
            if (!examSubmitted) {
                reportWindowChangeViolation();
            }
        });

        // Prevent right-click
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });

        // Prevent keyboard shortcuts that might exit fullscreen or copy content
        document.addEventListener('keydown', function(e) {
            // F11, Esc (when in fullscreen), Alt+Tab
            if (e.keyCode === 122 || 
                (e.keyCode === 27 && isFullscreen) || 
                (e.altKey && e.keyCode === 9)) {
                e.preventDefault();
                return false;
            }
            
            // Prevent copy shortcuts (Ctrl+C, Ctrl+X, Ctrl+A, Ctrl+P, Ctrl+S)
            if ((e.ctrlKey || e.metaKey) && 
                (e.keyCode === 67 || e.keyCode === 88 || e.keyCode === 65 || 
                 e.keyCode === 80 || e.keyCode === 83)) {
                e.preventDefault();
                reportCopyAttemptViolation();
                return false;
            }
            
            // Prevent Print Screen and other screenshot shortcuts
            if (e.keyCode === 44 || // Print Screen
                e.keyCode === 121 || // F10
                (e.ctrlKey && e.shiftKey && e.keyCode === 83) || // Ctrl+Shift+S (Windows screenshot)
                (e.metaKey && e.shiftKey && e.keyCode === 4) || // Cmd+Shift+4 (Mac screenshot)
                (e.metaKey && e.shiftKey && e.keyCode === 3) || // Cmd+Shift+3 (Mac screenshot)
                (e.metaKey && e.shiftKey && e.keyCode === 5) || // Cmd+Shift+5 (Mac screenshot)
                (e.ctrlKey && e.altKey && e.keyCode === 80) || // Ctrl+Alt+P (some screenshot tools)
                (e.ctrlKey && e.altKey && e.keyCode === 83) || // Ctrl+Alt+S (some screenshot tools)
                (e.ctrlKey && e.keyCode === 44) || // Ctrl+Print Screen
                (e.altKey && e.keyCode === 44)) { // Alt+Print Screen
                e.preventDefault();
                triggerAntiScreenshot();
                return false;
            }
            
            // Prevent function keys that might be used for screenshots
            if (e.keyCode >= 112 && e.keyCode <= 123) { // F1-F12
                e.preventDefault();
                triggerAntiScreenshot();
                return false;
            }
        });

        // Prevent drag and drop
        document.addEventListener('dragstart', function(e) {
            e.preventDefault();
            return false;
        });

        // Prevent text selection - but only for non-form elements
        document.addEventListener('selectstart', function(e) {
            // Allow selection for form inputs
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                reportCopyAttemptViolation();
                return false;
            }
        });

        // Prevent copy event - but only for non-form elements
        document.addEventListener('copy', function(e) {
            // Allow copy for form inputs
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                reportCopyAttemptViolation();
                return false;
            }
        });

        // Prevent cut event - but only for non-form elements
        document.addEventListener('cut', function(e) {
            // Allow cut for form inputs
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                reportCopyAttemptViolation();
                return false;
            }
        });

        // Prevent paste event - but only for non-form elements
        document.addEventListener('paste', function(e) {
            // Allow paste for form inputs
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                return false;
            }
        });

        // Prevent print
        window.addEventListener('beforeprint', function(e) {
            e.preventDefault();
            reportCopyAttemptViolation();
            return false;
        });

        // Prevent developer tools
        document.addEventListener('keydown', function(e) {
            // F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
            if (e.keyCode === 123 || 
                (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) || 
                (e.ctrlKey && e.keyCode === 85)) {
                e.preventDefault();
                reportCopyAttemptViolation();
                return false;
            }
        });

        // Detect developer tools
        let devtools = {open: false, orientation: null};
        setInterval(() => {
            if (window.outerHeight - window.innerHeight > 200 || 
                window.outerWidth - window.innerWidth > 200) {
                if (!devtools.open) {
                    devtools.open = true;
                    reportCopyAttemptViolation();
                }
            } else {
                devtools.open = false;
            }
        }, 500);

        // Add CSS to prevent screenshots in some browsers
        const style = document.createElement('style');
        style.innerHTML = `
            * {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            
            input, textarea {
                -webkit-user-select: text;
                -khtml-user-select: text;
                -moz-user-select: text;
                -ms-user-select: text;
                user-select: text;
            }
            
            /* Prevent screenshots in some browsers */
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                image-rendering: -webkit-optimize-contrast;
            }
            
            /* Prevent drag and drop of images */
            img {
                -webkit-user-drag: none;
                user-drag: none;
                pointer-events: none;
            }
        `;
        document.head.appendChild(style);

        // Clear clipboard more frequently to prevent screenshot copying
        setInterval(() => {
            if (isFullscreen && !examSubmitted) {
                try {
                    navigator.clipboard.writeText('');
                    updateDebugInfo("Clipboard cleared");
                } catch (e) {
                    // Clipboard API might not be available or permission denied
                    updateDebugInfo("Could not clear clipboard: " + e.message);
                }
            }
        }, 5000); // Clear clipboard every 5 seconds

        // Detect if the page is being viewed in a frame (to prevent iframing for screenshots)
        if (window.self !== window.top) {
            // Page is in a frame
            window.top.location = window.self.location;
        }

        // Monitor for potential screenshot tools
        let screenshotDetectionInterval = setInterval(() => {
            if (isFullscreen && !examSubmitted) {
                // Check for common screenshot processes
                const suspiciousProcesses = ['snippingtool', 'snip', 'screenshot', 'capture', 'record', 'obs', 'bandicam'];
                
                // Random checks to detect potential recording
                if (Math.random() < 0.2) { // 20% chance each interval
                    updateDebugInfo("Checking for screen recording software...");
                    
                    // In a real implementation, you might use more sophisticated detection
                    // For now, we'll rely on keyboard shortcuts and other detection methods
                }
            }
        }, 3000); // Check every 3 seconds

        // Add a dynamic watermark
        function addDynamicWatermark() {
            const watermark = document.createElement('div');
            watermark.style.position = 'fixed';
            watermark.style.top = '0';
            watermark.style.left = '0';
            watermark.style.width = '100%';
            watermark.style.height = '100%';
            watermark.style.pointerEvents = 'none';
            watermark.style.zIndex = '9999';
            watermark.style.opacity = '0';
            watermark.style.backgroundImage = `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Ctext x='50%25' y='50%25' font-size='16' text-anchor='middle' dominant-baseline='middle' transform='rotate(-45 150 150)' fill='%23000' opacity='0.2'%3E${username} - ${exam} - ${new Date().toLocaleString()}%3C/text%3E%3C/svg%3E")`;
            watermark.style.backgroundRepeat = 'repeat';
            watermark.id = 'dynamic-watermark';
            document.body.appendChild(watermark);
            
            // Update watermark timestamp periodically
            setInterval(() => {
                if (isFullscreen && !examSubmitted) {
                    watermark.style.backgroundImage = `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Ctext x='50%25' y='50%25' font-size='16' text-anchor='middle' dominant-baseline='middle' transform='rotate(-45 150 150)' fill='%23000' opacity='0.2'%3E${username} - ${exam} - ${new Date().toLocaleString()}%3C/text%3E%3C/svg%3E")`;
                }
            }, 60000); // Update every minute
        }

        // Monitor for screen capture API usage
        const originalGetDisplayMedia = navigator.mediaDevices.getDisplayMedia;
        if (originalGetDisplayMedia) {
            navigator.mediaDevices.getDisplayMedia = function() {
                triggerAntiScreenshot();
                return Promise.reject(new Error('Screen capture is not allowed during exams'));
            };
        }

        // Monitor for potential screenshot attempts by checking for unexpected focus changes
        let lastFocusTime = Date.now();
        document.addEventListener('focus', function() {
            const now = Date.now();
            if (now - lastFocusTime < 100) { // Rapid focus changes might indicate screenshot tools
                triggerAntiScreenshot();
            }
            lastFocusTime = now;
        }, true);

        // Add a random check for screenshot attempts
        setInterval(() => {
            if (isFullscreen && !examSubmitted && Math.random() < 0.05) { // 5% chance
                updateDebugInfo("Random screenshot check...");
                // In a real implementation, you might use more sophisticated detection
            }
        }, 10000); // Check every 10 seconds

        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                video.srcObject = stream;
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);
                analyser.smoothingTimeConstant = 0.8;
                analyser.fftSize = 1024;
                microphone.connect(analyser);
                analyser.connect(javascriptNode);
                javascriptNode.connect(audioContext.destination);

                javascriptNode.onaudioprocess = function() {
                    const array = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(array);
                    let values = 0;
                    const length = array.length;
                    for (let i = 0; i < length; i++) {
                        values += array[i];
                    }
                    const average = values / length;
                    if (average > 30) {
                        isNoiseViolation = true;
                    } else {
                        isNoiseViolation = false;
                    }
                };
                
                // After getting camera access, prompt for fullscreen
                setTimeout(() => {
                    if (!isFullscreen) {
                        fullscreenWarning.style.display = 'flex';
                    }
                    // Initialize screenshot prevention measures
                    addDynamicWatermark();
                }, 2000);
                
                updateDebugInfo("Camera and microphone access granted");
            })
            .catch(err => {
                console.error("Error accessing media devices.", err);
                status.innerText = "Error: Could not access camera or microphone.";
                updateDebugInfo(`Error accessing media devices: ${err.message}`);
            });

        setInterval(() => {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const dataURL = canvas.toDataURL('image/png');

            // MODIFIED: Include reference_face in the request body
            let body = `image=${encodeURIComponent(dataURL)}&username=${encodeURIComponent(username)}&noise_violation=${isNoiseViolation}`;
            if (referenceFace) {
                body += `&reference_face=${encodeURIComponent(referenceFace)}`;
            }

            updateDebugInfo(`Sending capture request... Noise violation: ${isNoiseViolation}`);

            fetch('/capture', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: body
            })
            .then(res => res.text())
            .then(resp => {
                updateDebugInfo(`Server response: ${resp}`);
                
                if(resp === 'FACE_MISMATCH'){
                    status.innerText = "Face Mismatch. Exam Terminated!";
                    video.pause();
                    alert("Face mismatch detected. The exam will be terminated.");
                    window.location.href = "/";
                } else if(resp === 'MULTIPLE_FACES'){
                    status.innerText = "Multiple Faces Detected. Exam Terminated!";
                    video.pause();
                    alert("Multiple faces detected. The exam will be terminated.");
                    window.location.href = "/";
                } else if(resp === 'MAX_VIOLATIONS'){
                    status.innerText = "Maximum Violations Reached. Exam Terminated!";
                    video.pause();
                    alert("The maximum violations reached. Exam terminated.");
                    window.location.href = "/";
                } else if(resp.startsWith('VIOLATION:')) {
                    // Updated parsing logic to handle different violation types
                    const respParts = resp.split(':');
                    const violationType = respParts[1]; // e.g., PROHIBITED_ITEM, NOISE_VIOLATION
                    const count = parseInt(respParts[respParts.length - 1]);
                    
                    // Only update if count is higher than last count to prevent duplicates
                    if (count > lastViolationCount) {
                        lastViolationCount = count;
                        violationCountSpan.innerText = count;
                        violationBadge.style.display = 'inline-block';
                        
                        let statusMessage = `Violation ${count}: `;
                        if (violationType === 'NOISE_VIOLATION') {
                            statusMessage += "Excessive noise detected! Please remain silent.";
                        } else if (violationType === 'GAZE_VIOLATION') {
                            statusMessage += "Gaze violation! Please look at the screen.";
                        } else if (violationType === 'PROHIBITED_ITEM') {
                            const itemType = respParts[2]; // e.g., MOBILE_PHONE, BOOK
                            if (itemType === 'MOBILE_PHONE' || itemType === 'LAPTOP' || itemType === 'AIRPODS_OR_HEADSET') {
                                statusMessage += "Electronic device detected.";
                            } else if (itemType === 'BOOK') {
                                statusMessage += "Books or notes detected! Please remove them.";
                            } else {
                                statusMessage += "Prohibited item detected! Please remove it.";
                            }
                        } else if (violationType === 'FULLSCREEN_VIOLATION') {
                            statusMessage += "You exited fullscreen mode. Please return to fullscreen.";
                        } else if (violationType === 'TAB_CHANGE_VIOLATION') {
                            statusMessage += "Tab change detected! Please focus on the exam.";
                        } else if (violationType === 'WINDOW_CHANGE_VIOLATION') {
                            statusMessage += "Window change detected! Please focus on the exam.";
                        } else if (violationType === 'COPY_ATTEMPT_VIOLATION') {
                            statusMessage += "Copy attempt detected! Copying questions is not allowed.";
                        } else if (violationType === 'SCREENSHOT_VIOLATION') {
                            statusMessage += "Screenshot or screen recording detected! This is strictly prohibited.";
                            showScreenshotWarning();
                        } else {
                            statusMessage += "Proctoring violation detected!";
                        }
                        status.innerText = statusMessage;
                        status.classList.add('violation');
                        
                        violationBadge.style.animation = 'none';
                        setTimeout(() => {
                            violationBadge.style.animation = 'blink 1s linear infinite';
                        }, 10);
                    }
                } else {
                    // If no violation, ensure the status is not a violation message
                    if (status.classList.contains('violation')) {
                       status.classList.remove('violation');
                    }
                    if (!status.innerText.includes("Violation")) {
                       status.innerText = "Exam in progress...";
                    }
                }
            })
            .catch(err => {
                console.error('Error during capture:', err);
                status.innerText = "Error during proctoring check. Please check your connection.";
                updateDebugInfo(`Error during capture: ${err.message}`);
            });
        }, 10000); // Capture every 10 seconds

        function submitMCQ() {
            examSubmitted = true;
            const form = document.getElementById('mcq-form');
            const formData = new FormData(form);
            const answers = { q1: 'b', q2: 'd', q3: 'a', q4: 'b', q5: 'a' };
            let score = 0;
            for (let [q, a] of Object.entries(answers)) {
                if (formData.get(q) === a) score++;
            }
            fetch('/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `username=${encodeURIComponent(username)}&score=${score}`
            })
            .then(res => res.text())
            .then(() => {
                // Exit fullscreen before redirecting
                exitFullscreen();
                window.location.href = `/score?user=${encodeURIComponent(username)}`;
            })
            .catch(err => {
                console.error(err);
                updateDebugInfo(`Error submitting exam: ${err.message}`);
            });
        }
    </script>
</body>
</html>